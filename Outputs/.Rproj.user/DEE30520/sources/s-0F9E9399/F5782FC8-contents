###########################
#Modulo 2 -Primera Parte - filtrados
###########################
library(dplyr)
library(readr)
agregados <- read_csv("C:/cursoR/agregados.csv")
View(agregados)
cmadrid<-filter(agregados, CCAA=="CM")
View(cmadrid)
MadridyCatal<-filter(agregados, (CCAA=="CM") | (CCAA=="CT"))
View(MadridyCatal)
Madrid.cota<-filter(agregados, CCAA=="CM", (Hospitalizados>=8000) )
View(Madrid.cota)
SinMadrid<-filter(agregados, CCAA!="CM")
################################################
#Modulo 2 - Segunda parte - seleccion de variables
################################################
library(dplyr)
library(readr)
agregados <- read_csv("C:/cursoR/agregados.csv")
View(agregados)
cmadrid<-filter(agregados, CCAA=="CM")
View(cmadrid)

Madrid.fallecidos<-select(cmadrid, FECHA, Fallecidos)
plot(Madrid.fallecidos$Fallecidos, col='red', main="fallecidos en CM")
#
cmadrid<-select(cmadrid, -CCAA)
#
cmadrid<-rename(cmadrid, Infectados=CASOS)
#
#Madrid.PCR<-select(cmadrid, PCR+) #da error por el signo +
names(cmadrid) #observo cual es la lista de nombres de las variables
names(cmadrid)[3]<-"PCR" #modifico el nombre de la variable tercera
names(cmadrid)[4]<-"TestAC" #idem
names(cmadrid)#compruebo el resultado

#calculamos nuevas variables o modificacamos una existente
cmadrid<-mutate(cmadrid, Infectados=PCR+TestAC)
plot(cmadrid$Infectados) #se observa que faltan muchos datos
#Observamos el problema de demasiados NA, en este caso, lo sencillo
#es sustituir los NA por ceros
#Una forma de hacerlo es esta:
tam<-dim(cmadrid)
for (i in 1:tam[1]){
  for (j in 1:tam[2]){
    if (is.na(cmadrid[i,j])) {cmadrid[i,j]<-0}
  }
}
#Ahora debo volver a recalcular Infectados (39) y a replotear (40)

#Calculamos el indice de transmision R con referencia a 14 dias:
attach(cmadrid)
Rindex<-rep(0,length(Infectados))
for (i in (15:length(Infectados))){
  Rindex[i]<-Infectados[i]/Infectados[i-14]
}
detach(cmadrid)
#creamos una nueva variable en el dataset cmadrid
cmadrid<-mutate(cmadrid, RIndex=Rindex)

#Evolucion del numero R de transmision del covid19
plot(Rindex,col="red", type="l")
#Observamos los valores de la columna RIndex en la tabla cmadrid
#Ceros- Inf (Infinito) - valores reales

#Aqui empieza el trabajo practico:
#1.Comenta las siguientes instrucciones:
datos.ac1<-select(cmadrid,FECHA, Infectados, Hospitalizados:Fallecidos)
#
datos.ac2<-select(cmadrid,1:2, 5:7)
#
Dia<-1:length(cmadrid$FECHA)
#
mascmadrid<-mutate(mascmadrid, DIA=Dia)
#
plot(mascmadrid$DIA, mascmadrid$Infectados, 
     xlab= "D?a", ylab="Infectados",main="Infecciones en la CM por d?a")
# 
#
#2. Calcula una nueva variable en cmadrid que contenga el resultado de:
#Infectados-(Hospitalizados+UCI+Fallecidos)


#3. Representa los resultados de esa variable desde la fecha disponible


################################################
#Modulo 3 - Tercera parte - organizacion de los datos
################################################
library(dplyr)
library(readr)
agregados <- read_csv("C:/cursoR/agregados.csv")
View(agregados)

agregados.sort<-arrange(agregados, CCAA)

#eliminar las primeras 5 lineas de observaciones

agregados.sort<-agregados.sort[6:length(agregados$CCAA),]

#ordenación descencente:
agregados.sort<-arrange(agregados.sort, desc(CCAA))


# apartir de aquí trabajamos con la base de datos desagregados
#se muestran los datos diarios totales en España:
library(readr)
desagregados <- read_delim("C:/cursoR/desagregados.csv", 
                           ";", escape_double = FALSE, trim_ws = TRUE, skip = 2)

View(desagregados)

# Fecha en la que se ha producido el máximo número de contagios
desagregados.sort<-arrange(desagregados, desc(CONTAGIADOS))
desagregados.sort[1,1]

# Calculamos el número medio de contagios diarios:
summarize(desagregados, mean(CONTAGIADOS, rm.na=T))
# Otra forma equivalente:
mean(desagregados$CONTAGIADOS, rm.na=T)
# Observamos el redondeo
fechas<-desagregados$Dia
fechas<-as.Date(fechas, "%d/%m/%y") 
meses<-months(fechas)
datos<-select(desagregados, Dia, CONTAGIADOS, HOSPITALIZADOS, UCI, FALLECIDOS, RECUPERADOS)
datos<-mutate(datos, mes=meses)
#reordenar las posiciones de las variables:
datos<-select(datos, mes, CONTAGIADOS, everything())
#agrupamos por meses y calculamos el n?mero de contagios medio:
por_mes<-group_by(datos, mes)
summarize(por_mes, media_casos=mean(CONTAGIADOS, na.rm=T))

#Ejercicios propuestos:
#1. Con los datos de agregados, seleccionar las variables CCAA, Fecha
# PRC+ y TestAc+ 

#2. Realizar una agrupaci?n por 
#comunidades aut?nomas y calcular el n?mero m?ximo de infectados
#en cada una de ellas.
#############################################################
# EJERCICIO DE ENTRADA - SALIDA ###################
#######################################################
# DESCARGA DE DATOS CSV DIRECTAMENTE DE UNA WEB
datoscovid<-read.csv("https://cnecovid.isciii.es/covid19/resources/agregados.csv")
# ELIMINAMOS LOS DATOS DEL FINAL DE LA TABLA
datoscovid<-datoscovid[1:1729,]
# otra forma de hacerlo es esta:
datoscovid<-datoscovid[-(1730:length(datoscovid$CCAA)),]
# CREAMOS UN OBJETO CON LOS DATOS DE LA COMUNIDAD DE MADRID
# DEBEMOS FILTRAR LAS FILAS CUYA VARIABLE CCAA SEA CM:
CM<-datoscovid[(CCAA=="CM"),] 
#GUARDAMOS EL RESULADO EN EL ARCHIVO "datoscovidCM.csv"
write.csv(CM, "D:\\cursoR\\datoscovidCM1.csv")
write.csv(CM, "D:/cursoR/datoscovidCM2.csv")

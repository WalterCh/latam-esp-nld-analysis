---
title: "COVID-19 Latam + Esp + Nld Analysis"
author: "Walter Chanavá"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: spacelab
    highlight: tango
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,
                      message = F,
                      error = F,
                      fig.align = 'center',
                      warning = F)
```

```{r echo=FALSE, out.width="75%"}
knitr::include_graphics("covid-image.jpg")
```

# Loading and Exploring Data

## Packages

```{r packages}
library(readr)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(tidyr)
library(lubridate)
```

- readr: reading files
- dplyr: to manipulate the tables
- ggplot2: to visualize the data
- ggrepel: to add labels in plots
- tidyr: to manipulate the data
- lubridate: to work with dates in R

```{r sourcing functions}
source("../Scripts/R0-function.R")
source("../Scripts/custom-ggplot2-theme.R")
source("../Scripts/Moving-average-function.R")
```

## Data {.tabset}

```{r data}
covid <- read_csv("../Data/VariosPaises_Covid19Actualizado.csv", na = "#VALUE!")

country_pops <- tibble(
  COUNTRY = unique(covid$COUNTRY),
  POP = c(11673021, 212559417, 212559417, 50882891, 17643054,
          6486205, 17915568, 128932753, 17134872, 7132538,
          32971854, 2860853, 46754778, 3473730)
)

covid_tbl <- covid %>% 
  left_join(country_pops) %>%
  mutate(CONTAGIADOS_POND = CONTAGIADOS/POP,
         CONTAGIADOS_MILL = CONTAGIADOS/1000000) %>%
  group_by(COUNTRY) %>% 
  mutate(CONTAGIADOS_MA = mov_avg(CONTAGIADOS, 7),
         FALLECIDOS_MA = mov_avg(FALLECIDOS, 7),
         RECUPERADOS_MA = mov_avg(RECUPERADOS, 7)) %>% 
  mutate(DIA = 1:n()) %>% 
  ungroup() %>% 
  mutate(COUNTRY = as.factor(COUNTRY),
         FECHA = as.Date(FECHA, "%d/%m/%Y"),
         SEMANA = as.numeric(strftime(FECHA, format = "%V")),
         IP = CONTAGIADOS + FALLECIDOS - RECUPERADOS,
         IP_MA = CONTAGIADOS_MA + FALLECIDOS_MA - RECUPERADOS_MA,
         R0_3 = R0(CONTAGIADOS, 3),
         R0_7 = R0(CONTAGIADOS, 7),
         R0_14 = R0(CONTAGIADOS, 14),
         R0_14_MA = R0(CONTAGIADOS_MA, 14))
covid_tbl
```

The dataset consists of 2300 observations of daily cases of COVID-19 from 14 Latin america countries, plus Spain and Netherlands, from March 2nd to Sep 9th of 2020.

### Infected {-}

#### All-together

```{r}
ggplot(data = covid_tbl %>% 
         filter(FECHA <= as.Date("2020-08-09")), 
       aes(x = FECHA, y = CONTAGIADOS_MA, col = COUNTRY)) +
  geom_point() +
  geom_line() +
  # geom_smooth(se = FALSE) +
  geom_label_repel(data = . %>% filter(FECHA == as.Date("2020-08-09"),
                                       COUNTRY %in% c("BRAZIL", "PERU", 
                                                      "MEXICO", "COLOMBIA")), 
                   aes(label = COUNTRY), family = "Poppins", 
                   xlim = as.Date("2020-08-15"), ylim = c(3000, 40000)) +
  geom_label(aes(label = "*"), family = "Poppins", x = as.Date("2020-08-20"),
             y = 1500, col = "black") +
  scale_x_date(date_labels = "%b",
               limits = as.Date(c("2020-03-01", "2020-09-15")),
               breaks = seq.Date(from = as.Date("2020-03-01"),
                                 to = as.Date("2020-09-01"),
                                 by = "month")) +
  custom_theme +
  labs(y = "CONTAGIADOS", caption = "* Países con número de contagiados en la última semana menor a 5000: Chile,\nBolivia, Ecuador, Guatemala, Paraguay, España, Puerto Rico, El Salvador, Países Bajos y\nUruguay")
```

#### Group 1

```{r fig.width=5, fig.heigth = 4}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("URUGUAY")), 
       aes(x = FECHA, y = CONTAGIADOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Group 2

```{r fig.width=10, fig.height=7}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("EL SALVADOR", "PUERTO RICO", "PARAGUAY")), 
       aes(x = FECHA, y = CONTAGIADOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  facet_wrap(~COUNTRY, nrow = 2) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Group 3

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("GUATEMALA", "NETHERLAND", "BOLIVIA",
                               "ECUADOR")), 
       aes(x = FECHA, y = CONTAGIADOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Group 4

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("CHILE", "SPAIN", "MEXICO", "COLOMBIA",
                               "PERU")), 
       aes(x = FECHA, y = CONTAGIADOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Group 5

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("BRAZIL")), 
       aes(x = FECHA, y = CONTAGIADOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-03-01"), 
                                 to = as.Date("2020-09-01"), 
                                 by = "month")) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

### Deaths {-}

#### All-together

```{r}
ggplot(data = covid_tbl %>% 
         filter(FECHA <= as.Date("2020-08-09")), 
       aes(x = FECHA, y = FALLECIDOS_MA, col = COUNTRY)) +
  geom_point() +
  geom_line() +
  # geom_smooth(se = FALSE) +
  geom_label_repel(data = . %>% filter(FECHA == as.Date("2020-08-09"),
                                       COUNTRY %in% c("BRAZIL", "PERU", 
                                                      "MEXICO", "COLOMBIA")), 
                   aes(label = COUNTRY), family = "Poppins", 
                   xlim = as.Date("2020-08-15"), ylim = c(100, 950)) +
  geom_label(aes(label = "*"), family = "Poppins", x = as.Date("2020-08-20"),
             y = 50, col = "black") +
  scale_x_date(date_labels = "%b",
               limits = as.Date(c("2020-03-01", "2020-09-15")),
               breaks = seq.Date(from = as.Date("2020-03-01"),
                                 to = as.Date("2020-09-01"),
                                 by = "month")) +
  custom_theme +
  labs(y = "MUERTES", caption = "* Países con número de muertes menor a 100 en la ultima semana: Chile,\nBolivia, Ecuador, Guatemala, Paraguay, España, Puerto Rico, El Salvador, Países Bajos y\nUruguay")
```

#### Group 1

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("URUGUAY")), 
       aes(x = FECHA, y = FALLECIDOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Group 2

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("EL SALVADOR", "PUERTO RICO", "PARAGUAY")), 
       aes(x = FECHA, y = FALLECIDOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~COUNTRY, nrow = 2) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Group 3

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("GUATEMALA", "NETHERLAND", "BOLIVIA",
                               "ECUADOR")), 
       aes(x = FECHA, y = FALLECIDOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Group 4

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("CHILE", "SPAIN", "MEXICO", "COLOMBIA",
                               "PERU")), 
       aes(x = FECHA, y = FALLECIDOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Group 5

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("BRAZIL")), 
       aes(x = FECHA, y = FALLECIDOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-03-01"), 
                                 to = as.Date("2020-09-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

### IP {-}

#### Grupo 1

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("URUGUAY")), 
       aes(x = FECHA, y = IP)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

## Grupo 2

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("EL SALVADOR", "PUERTO RICO", "PARAGUAY")), 
       aes(x = FECHA, y = IP)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~COUNTRY, nrow = 2) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Grupo 3

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("GUATEMALA", "NETHERLAND", "BOLIVIA",
                               "ECUADOR")), 
       aes(x = FECHA, y = IP)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma, limits = c(-800, 1800)) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Grupo 4

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("CHILE", "SPAIN", "MEXICO", "COLOMBIA",
                               "PERU")), 
       aes(x = FECHA, y = IP)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-04-01"), 
                                 to = as.Date("2020-08-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma, limits = c(-2000, 8200)) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Grupo 5

```{r}
ggplot(data = covid_tbl %>% 
         filter(COUNTRY %in% c("BRAZIL")), 
       aes(x = FECHA, y = FALLECIDOS)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(date_labels = "%b",
               breaks = seq.Date(from = as.Date("2020-03-01"), 
                                 to = as.Date("2020-09-01"), 
                                 by = "month")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~COUNTRY) +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

### R0 {-}

#### Grupo 1

```{r}
covid_tbl %>% 
  filter(COUNTRY == "URUGUAY") %>% 
  ggplot(aes(x = FECHA, y = R0_14)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_wrap(~COUNTRY) +
  scale_x_date(limit = c(as.Date("2020-03-25"), as.Date("2020-08-23"))) +
  scale_y_continuous(limit = c(0, 25)) +
  labs(y = "R0") +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Grupo 2

```{r}
covid_tbl %>% 
  filter(COUNTRY %in% c("EL SALVADOR", "PUERTO RICO", "PARAGUAY")) %>% 
  ggplot(aes(x = FECHA, y = R0_14)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_wrap(~COUNTRY) +
  scale_x_date(limit = c(as.Date("2020-03-25"), as.Date("2020-08-23"))) +
  scale_y_continuous(limit = c(0, 25)) +
  labs(y = "R0") +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Grupo 3

```{r}
covid_tbl %>% 
  filter(COUNTRY %in% c("GUATEMALA", "NETHERLAND", "BOLIVIA",
                        "ECUADOR")) %>% 
  ggplot(aes(x = FECHA, y = R0_14)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_wrap(~COUNTRY) +
  scale_x_date(limit = c(as.Date("2020-03-25"), as.Date("2020-08-23"))) +
  scale_y_continuous(limit = c(0, 25)) +
  labs(y = "R0") +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Grupo 4

```{r}
covid_tbl %>% 
  filter(COUNTRY %in% c("CHILE", "SPAIN", "MEXICO", "COLOMBIA",
                        "PERU")) %>% 
  ggplot(aes(x = FECHA, y = R0_14)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_wrap(~COUNTRY) +
  scale_x_date(limit = c(as.Date("2020-03-25"), as.Date("2020-08-23"))) +
  scale_y_continuous(limit = c(0, 25)) +
  labs(y = "R0") +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

#### Grupo 5

```{r}
covid_tbl %>% 
  filter(COUNTRY == "BRAZIL") %>% 
  ggplot(aes(x = FECHA, y = R0_14)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_wrap(~COUNTRY) +
  scale_x_date(limit = c(as.Date("2020-03-25"), as.Date("2020-08-23"))) +
  scale_y_continuous(limit = c(0, 25)) +
  labs(y = "R0") +
  custom_theme +
  theme(strip.text = element_text(size = 15))
```

